# Changelog

このプロジェクトの全ての重要な変更を記録します。

フォーマットは [Keep a Changelog](https://keepachangelog.com/ja/1.0.0/) に基づいており、
バージョニングは [Semantic Versioning](https://semver.org/lang/ja/) に準拠しています。

## [Unreleased]

### Docs
- README を現行 React/Tauri 構成に合わせて再編成し、概要・セットアップ・利用フローを簡潔化
- `docs/USER_GUIDE.md` を追加して操作手順・辞書機能・トラブルシューティングを整理
- `docs/README.md` を更新し、新しいユーザーガイドへの導線とドキュメント更新方針を明確化

## [0.4.3] - 2025-11-06

### パフォーマンス最適化

**フェーズ1: クイックウィン（体感速度20-30%向上）**
- `buildColumnIndexMap` を共通ユーティリティに抽出（3コンポーネントで重複していたロジックを統一）
- `datasetAdapter` の再生成を最適化（依存配列を安定化し、不要な再レンダリングを削減）
- LocalStorage 書き込みにデバウンス処理を追加（400ms、beforeunload時に自動flush）
- 不要な依存値を除去し、useMemo/useCallback の効率を改善

**フェーズ2: アルゴリズム最適化（大量データ処理50-70%高速化）**
- `applyRegistrationToBOM` のアルゴリズムを O(n²) → O(n) に改善（Map構造を使用）
- `columnSamples` を専用フック `useColumnSamples` に抽出してキャッシュ化
- ストレージイベントリスナーに `deepEqual` による差分検出を実装（重複更新を回避）
- `editDatasets` をA/B個別のuseMemoに分割し、不要な再計算を抑制

**フェーズ3: アーキテクチャ改善（保守性・可読性向上）**
- `AppContext` を実装し、グローバル状態管理を一元化
- `App.tsx` を大幅にリファクタリング（948行 → 331行、65%削減）
- `ProjectStorage` クラスを実装し、ストレージ層を分離
- `EditableTable` に仮想スクロールを実装（200行以上で自動有効化、オーバースキャン8行）
- `DatasetCard`, `BOMWorkspace`, `EditWorkspace` を React.memo で最適化
- 循環依存を完全解消（`deriveColumns` を `core/bom-columns.ts` に移動）

### コードの構造改善

**新規フックの追加**
- `useEditModal`: 編集モーダルの状態とロジックを管理（約360行）
- `useComparison`: BOM比較・置換処理を管理（約180行）
- `useProjectSync`: プロジェクト同期ロジックを管理（約120行）
- `useDatasetHandlers`: データセット操作のハンドラーを集約（約110行）

**ユーティリティの追加**
- `src/utils/column-utils.ts`: 列インデックスマッピング共通化
- `src/utils/debounce.ts`: 汎用デバウンス実装（flush機能付き）
- `src/utils/deep-equal.ts`: 深い等価性チェック（Date/Set/Map対応）

**コンテナコンポーネントの整備**
- `src/containers/BOMWorkspace.tsx`: BOM操作UIを集約（125行）
- `src/containers/EditWorkspace.tsx`: 編集モーダルUIを集約（133行）

### 技術的改善

- TypeScript コンパイルエラー: 0件
- 循環依存: 0件（77ファイル処理）
- Vite ビルド時間: 588ms（最適化前とほぼ同等）
- バンドルサイズ: 421.63 kB（微増、許容範囲内）

### 開発者向けドキュメント

- 最適化実装計画を完了状態に更新
- パフォーマンス分析レポートを追加
- 最適化チェックリストを整備

## [0.4.2] - 2025-11-05

### 修正
- 差分比較結果や置き換え結果のエクスポートで古い状態が混ざるケースを解消し、React Context (`AppStateProvider`) を通じて常に最新の `currentDiffs` / `mergedBom` を共有するよう調整。

### 改善
- 置き換え結果テーブルに「残りの行を表示」操作を追加し、フィルター変更時に表示行数をリセットすることで大量結果の閲覧性を向上。
- BOM プレビューの表示行数を 15 行に拡張し、プレビューパネルと列設定パネルのレイアウトを調整して高さ・スクロール動作を最適化。
- レガシーな DOM ベースのイベントハンドラやモーダル関連コードを整理し、`AppStateProvider` による状態管理へ一本化。

## [0.4.1] - 2025-11-04

### 改善
- エクスポートエリアのボタン配色をほかのプライマリアクションと統一し、ホバー時と無効化時の視覚的一貫性を確保。
- グレーアウト表示されるお気に入りタブ向けのステート表示を追加し、削除済みであることが直感的に分かるように調整。

## [0.4.0] - 2025-11-04

### 変更
- 自動保存機能を完全廃止し、設定画面から自動保存関連の入力（間隔・保持数）を削除
- BOM 読み込み時の列検出ロジックを刷新し、Reference / Part_No / Manufacturer 列を複数行サンプルから推測。複数候補や開始行判定失敗時は「編集モードで指定してください」警告を返すよう変更
- 列役割の手動指定時にヘッダーラベルを役割名へ置き換え、Reference → Part_No → Manufacturer → その他の順でカラムを並べ替えるよう統一
- BOM A / BOM B それぞれのカードから PADS-ECO / CCF / MSF を個別にエクスポートできるよう UI を拡張し、比較結果のエクスポートグループを整理
- CAD エクスポート（CCF / MSF）を品番ごとのグルーピング出力に変更し、差分コメントの付与可否を統一
- スタイルシートと比較ビューを調整し、新しいエクスポート操作に合わせたボタンレイアウト・余白を適用
- 印刷機能を利用できるようメインウィンドウの capability に `core:webview:allow-print` を追加し、対応手順をドキュメントへ反映
- プロジェクト README を再構成し、全ディレクトリの役割を整理した `docs/DIRECTORY_COMMENTS.md` を追加
- Windows 向けビルドを自動化する GitHub Actions ワークフローを追加し、Bun のセットアップと利用手順をドキュメント化（npm optional dependency 問題を回避）

### 技術的詳細
- `src-hooks/useBOMData.ts`: 列役割マッピングに基づき `column_order` と `headers`/`columns` を正規化、役割変更時にも同処理を再適用
- `src-tauri/src/parsers/builder.rs`: データ開始行推測・複数候補警告・品番/メーカー列検出強化、Reference/Part_No/Manufacturer の警告を「編集モードで指定してください」で統一
- `src/components/BOMCompare.tsx`, `src/core/export-handler.ts`, `src-tauri/src/exporters/cad.rs`, `src/styles.css`: 各種エクスポート導線、CAD 出力フォーマット、UI レイアウトをアップデート
- `src/components/SettingsModal.tsx`: 自動保存関連の入力コントロールを削除
- `src/App.tsx`: アプリケーションヘッダーのバージョン表示を更新し、BOM カードのエクスポート操作を追加
- バージョン情報を `package.json` / `package-lock.json` / `src-tauri/Cargo.toml` / `src-tauri/tauri.conf.json` / `README.md` 等で `v0.4.0` に更新
- `CHANGELOG.md` / `docs/DEVELOPMENT.md` などドキュメントを v0.4.0 向けに調整

## [0.3.9] - 2025-11-04

### 改善
- お気に入りタブを削除してもグレーアウト表示で一覧に残し、クリックするだけで復元できるように改善。復元用スナップショットを localStorage にアーカイブし、保存・リネーム時にも最新状態を記録します。
- BOM エクスポートの「出力」ボタンをプライマリボタンと同じカラーリングに合わせ、ホバー時／無効化時の視覚表現を統一。

## [0.3.1] - 2025-10-30

### 修正
- **編集内容の自動保存**: 編集モーダルで保存後、プロジェクトに自動的に保存されるように修正
- **置き換え処理の改善**:
  - BOM A を BOM B で置き換えた際の不要なアラートを削除
  - 置き換え実行時にBOM Aのプレビューが上書きされる問題を修正（プレビューを保持）
  - 置き換え結果が自動保存時に消える問題を修正（プロジェクトID変更時のみリセット）
- **自動保存の無限ループ**: useEffectの依存配列を最適化し、「自動保存を開始しました」ログが無限に繰り返される問題を解消
- **タブ削除時の重複保存**: 最後のタブを削除した際に新規タブが重複保存される問題を修正

### 改善
- **タブ名の命名規則統一**: すべてのタブ作成方法で日付形式に統一
  - 旧: 「未命名タブ 1」「未命名タブ 2」...
  - 新: 「タブ 2025/10/30 14:23:45」（日本語ロケール形式）
  - BOMファイル読込時: 「[ファイル名] 2025/10/30 14:23:45」
- **プレビューレイアウトの最適化**:
  - 横並び表示の閾値を1200px→1000pxに変更（より小さい画面でも横並び表示）
  - プレビューテーブルに`flex-wrap`を追加し、レスポンシブ対応を強化
  - プレビューテーブルセルに最大幅（200px）と`text-overflow: ellipsis`を設定
  - カラム設定パネルのサイズを最適化（240px→220px、横並び時は200px）
- **モーダル表示の改善**:
  - モーダルサイズを調整（95vw×90vh → 90vw×85vh）で画面外表示を防止
  - 編集可能なテーブルラッパーに`max-width: 100%`を追加

### 技術的詳細
- `src/App.tsx`: 置き換え処理のBOM A上書きを削除、自動保存ループの依存配列を修正、プロジェクト切替ロジックを最適化
- `src/hooks/useProjects.ts`: `createProject`と`deleteProject`でのタブ名生成を`generateDefaultProjectName()`に統一
- `src/ui/edit-modal.ts`: `saveEdit`関数に`autoSaveActiveProject()`呼び出しを追加
- `src/styles.css`: プレビューとモーダルのレスポンシブ対応を強化
- `src/components/BOMCompare.tsx`: プレビュー構造は変更なし（CSSのみ変更）

### 追加機能（2025-10-24）
- **Chromeライクなタブ操作**:
  - 中クリック（ホイールクリック）でタブを閉じる機能
  - ドラッグ&ドロップによる新規ウィンドウ作成
  - ウィンドウ間のタブ統合（別ウィンドウからタブをドラッグして統合）
  - localStorage 監視による自動クリーンアップ（統合元ウィンドウからタブを自動削除）

### リファクタリング（2025-10-24）
- **完全モジュール化**: main.ts（4,286行）を21個のモジュールに分割
  - コアモジュール (src/core/): 5個（プロジェクト管理、辞書管理、エクスポート、前処理、設定管理）
  - UIモジュール (src/ui/): 16個（各UI機能を責務ごとに分離）
  - main.ts: 147行（エントリポイントのみ）
- **BomRow型の完全削除**: メモリ使用量を50%削減
  - すべての機能をParseResult（rows: string[][]）ベースに移行
  - 重複データ構造（normalizedBom）を削除
  - インデックスベースの参照に統一
- **型安全性の向上**: column_rolesをHashMap<String, Vec<String>>に変更
  - 複数列が同じ役割を持つことをサポート
  - ColumnRole型にpackage, quantity, remarksを追加
- **コード品質改善**:
  - 全モジュールにJSDocコメントを追加
  - TypeScriptコンパイルエラー: 0件
  - ビルドサイズ: 74.70 kB (gzip: 20.56 kB)
  - ビルド時間: 153ms

### 予定されている機能
- 単体テストの追加
- E2Eテストの追加
- パフォーマンス最適化
- アクセシビリティ改善
- IPC登録名を自動適用する `apply_ipc_names` コマンドのフロント連携（辞書・BOM 編集に統合予定）

## [0.1.0] - 2025-10-21

### 追加機能

#### BOM比較・マージ機能
- 2つのBOMファイルの差分比較機能
- 追加・削除・変更・一致の4種類の差分を色分けして表示
- マージBOMの自動生成
- 差分結果のCSVエクスポート

#### ファイル形式サポート
- **入力対応**: CSV, XLSX, CADネットリスト（PADS-ECO, MSF SHAPE, CCF DEFINITION）
- **出力対応**: CSV, PADS-ECO (.eco), CCF (.ccf), MSF (.msf)
- CADネットリスト形式の完全なパース・生成ロジック

#### 列の自動検出機能
- Ref（部品番号）列の自動検出
  - `Ref`, `Ref1`, `Ref2`, `RefDesignator`, `部品番号` などに対応
- Part_No（部品型番）列の自動検出
  - `Part_No`, `PartNo`, `MPN`, `型番` などに対応
  - "manufacturer"との誤検出を防止する除外ロジック
- Value, Comment, Manufacturer列の自動検出
- 3段階マッチング（完全一致 → 部分一致 → 日本語パターン）

#### 辞書機能（部品名管理）
- **登録名リスト**:
  - 部品型番（Part_No）と登録名（社内表記名）の紐付け管理
  - BOMから型番を自動抽出する機能
  - テーブル形式での直接編集（自動保存）
  - CSV インポート/エクスポート
  - BOMへの登録名一括適用
- **特定部品（例外ルール）**:
  - Ref + Part_No の組み合わせで個別の登録名を設定
  - 登録名リストより優先度が高い
  - CSV インポート/エクスポート
- localStorageでの永続化

#### ビジュアル前処理エディタ
- ブロックプログラミング風のパイプライン構築UI
- 利用可能なブロック:
  - 📋 Referenceの展開（`C1,C2,C3` → 個別行に展開）
  - ✂️ Referenceを行分割（1行複数Ref → 複数行に分割）
  - 🔄 空欄セルの補完
  - 🧹 テキストクリーニング（空白・特殊文字の除去）
  - ✨ 書式ルール適用
- ドラッグ&ドロップでブロックの順序変更
- トグルスイッチで個別ブロックの有効/無効切り替え
- ブロックの追加・削除・移動機能
- パイプライン設定のlocalStorage保存

#### タブ/プロジェクト管理
- **タブ管理**:
  - ヘッダーに現在のタブ名を表示
  - 鉛筆アイコンでタブ名のインライン編集
  - プロンプトベースの簡単なリネーム機能
- **お気に入り機能**:
  - 星アイコン（⭐）でお気に入りに追加/削除
  - お気に入りタブは金色の星で表示
  - タブリストの最上部に優先表示
  - localStorageで永続化
- **別ウィンドウで開く**:
  - Tauri WebviewWindow APIを使用
  - 複数プロジェクトの同時作業が可能
  - ウィンドウサイズ: 1400×900
- 複数プロジェクトのタブ管理
- 自動保存機能（設定可能な間隔）

#### データ編集機能
- BOMデータの直接編集機能
- 検索・置換機能
- セル単位での編集
- 編集内容のプレビュー

#### UI/UX改善
- レスポンシブデザイン
- ドラッグ&ドロップによるファイル読み込み
- ファイルピッカーによる読み込み
- 処理中オーバーレイ表示
- アクティビティログ（最新20件）
- ツールチップによる操作ガイド

### 技術的実装

#### フロントエンド
- TypeScript + Vanilla HTML/CSS
- Vite ビルドシステム
- 3,543行のメインロジック（src/main.ts）
- 1,710行のスタイルシート（src/styles.css）
- 718行のHTML構造（index.html）

#### バックエンド（Rust + Tauri 2.0）
- **パーサー**:
  - CSV パーサー（csv crate使用）
  - Excel パーサー（calamine crate使用）
  - CADネットリスト パーサー（PADS-ECO, MSF, CCF形式）
- **エクスポーター**:
  - CSV エクスポーター
  - CADネットリスト エクスポーター（PADS-ECO, CCF, MSF形式）
- **データ処理**:
  - Reference展開・分割ロジック
  - テキストクリーニング
  - 書式整形
  - バリデーション
- **ヘッダー自動検出**:
  - 多言語対応（英語・日本語）
  - 複数の列名パターンに対応
  - 誤検出防止ロジック
- **差分比較**:
  - BOM比較アルゴリズム
  - マージロジック
- **ストレージ**:
  - セッション管理
  - 辞書データ管理

### 変更点
- 初期テンプレートから大幅に拡張
- UIを垂直レイアウトに変更（横並び → 縦並び）
- モーダルベースの編集UIに変更

### 修正
- CADネットリストパーサーの完全書き直し（実際のフォーマットに対応）
- 列自動検出の精度向上（誤検出の削減）
- エラーハンドリングの改善

### セキュリティ
- ファイル読み込み時のバリデーション
- エラーメッセージの安全な表示

## [0.0.1] - 2025-10-16

### 追加
- プロジェクトの初期セットアップ
- Tauri 2.0 + TypeScript + Vite のテンプレート
- 基本的なプロジェクト構造

---

## 凡例

- `追加`: 新機能の追加
- `変更`: 既存機能の変更
- `非推奨`: まもなく削除される機能
- `削除`: 削除された機能
- `修正`: バグ修正
- `セキュリティ`: セキュリティに関する変更
