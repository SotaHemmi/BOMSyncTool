name: build-windows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      TAURI_SKIP_RELEASE_CHECK: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Bun runtime
        shell: powershell
        run: |
          irm https://bun.sh/install.ps1 | iex
          echo "$env:USERPROFILE\.bun\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Check Bun
        run: |
          bun --version
          where bun

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~\.cargo\registry
            ~\.cargo\git
          key: ${{ runner.os }}-cargo-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache Cargo target
        uses: actions/cache@v4
        with:
          path: src-tauri\target
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-

      - name: Install frontend dependencies
        run: bun install

      # ğŸš€ Tauri CLI v2 ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPATHç«¶åˆã‚’å›é¿ï¼‰
      - name: Install local Tauri CLI v2
        run: |
          cargo install --locked tauri-cli --version "^2.0.0" --root $env:GITHUB_WORKSPACE
          echo "Installed Tauri CLI under $env:GITHUB_WORKSPACE\bin"

      # ğŸ§¾ CLI ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªï¼ˆç¢ºå®Ÿã« v2 ã‚’åˆ©ç”¨ï¼‰
      - name: Check Tauri CLI version
        run: |
          Get-ChildItem $env:GITHUB_WORKSPACE\bin
          & "$env:GITHUB_WORKSPACE\bin\cargo-tauri.exe" --version

      # ğŸ§¹ å¤ã„ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒæ™‚ã«æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ··ã–ã‚‹ã®ã‚’é˜²æ­¢ï¼‰
      - name: Clean previous bundle artifacts
        shell: powershell
        run: |
          if (Test-Path "src-tauri/target/release/bundle") {
            Write-Host "Removing existing bundle directory..."
            Remove-Item "src-tauri/target/release/bundle" -Recurse -Force
          }

      # ğŸ—ï¸ v2 æ­£å¼ãƒ“ãƒ«ãƒ‰ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ä»˜ãï¼NSISã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼‰
      - name: Build Windows installer (.exe)
        run: |
          & "$env:GITHUB_WORKSPACE\bin\cargo-tauri.exe" build --bundles nsis

      # ğŸ“¦ é…å¸ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æº–å‚™
      - name: Prepare distribution package
        shell: powershell
        run: |
          # é…å¸ƒç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          New-Item -ItemType Directory -Force -Path dist-package

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼
          Copy-Item src-tauri/target/release/bundle/nsis/*.exe dist-package/

          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          Copy-Item docs/USER_MANUAL.md dist-package/

          # READMEï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ï¼‰ã‚’ä½œæˆ
          @"
          # BOMSyncTool - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰

          ## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          1. ã“ã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã® .exe ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
          2. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Œäº†ã—ã¦ãã ã•ã„
          3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†å¾Œã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¾ãŸã¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰èµ·å‹•ã§ãã¾ã™

          ## ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«

          ã“ã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã® USER_MANUAL.md ã‚’é–‹ã„ã¦ã€ä½¿ã„æ–¹ã®è©³ç´°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

          ## ã‚µãƒãƒ¼ãƒˆ

          å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€GitHubã®Issuesãƒšãƒ¼ã‚¸ã§å ±å‘Šã—ã¦ãã ã•ã„ã€‚
          "@ | Out-File -FilePath dist-package/README.txt -Encoding UTF8

      # ğŸ’¾ æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload distribution package
        uses: actions/upload-artifact@v4
        with:
          name: bomsynctool-windows-package
          path: dist-package/*
