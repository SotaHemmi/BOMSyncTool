<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BOMSyncTool</title>
  </head>
  <body>
    <main class="app-shell">
      <header class="shell-header">
        <div class="brand">
          <h1>
            BOMSyncTool
            <span class="brand-version" aria-label="version 0.10">v0.10</span>
          </h1>
          <div class="current-tab-display" id="current-tab-display">
            <span class="current-tab-name" id="current-tab-name">未命名タブ</span>
          </div>
        </div>
        <div class="header-actions">
          <button
            class="icon-button"
            id="create-new-tab"
            aria-label="新しいタブを作成"
            data-tooltip="空のタブを追加します"
          >
            <span>＋</span>
          </button>
          <button
            class="icon-button"
            id="open-tab-window"
            aria-label="タブを新しいウィンドウで開く"
            data-tooltip="現在のタブを新しいウィンドウで開きます"
          >
            <span>↗︎</span>
          </button>
          <button
            class="icon-button"
            id="open-settings"
            aria-label="設定を開く"
            data-tooltip="アプリ全体の設定や辞書を管理します"
          >
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M12 8.9a3.1 3.1 0 1 0 0 6.2 3.1 3.1 0 0 0 0-6.2Zm8.94 2.2-1.16-.2a7.14 7.14 0 0 0-.54-1.32l.7-.94a.76.76 0 0 0-.05-.97l-1.38-1.38a.75.75 0 0 0-.97-.06l-.94.7a7.14 7.14 0 0 0-1.32-.54l-.2-1.16A.76.76 0 0 0 14.08 5h-1.95a.76.76 0 0 0-.74.63l-.2 1.16a7.14 7.14 0 0 0-1.32.54l-.94-.7a.75.75 0 0 0-.97.05L6.58 8.06a.75.75 0 0 0-.05.97l.7.94a7.14 7.14 0 0 0-.54 1.32l-1.16.2A.76.76 0 0 0 5 11.92v1.95c0 .37.27.69.63.74l1.16.2c.12.45.3.89.54 1.32l-.7.94a.76.76 0 0 0 .05.97l1.38 1.38c.25.25.64.29.97.06l.94-.7c.43.24.87.42 1.32.54l.2 1.16c.05.36.37.63.74.63h1.95c.37 0 .69-.27.74-.63l.2-1.16c.45-.12.89-.3 1.32-.54l.94.7c.33.23.72.19.97-.06l1.38-1.38a.75.75 0 0 0 .06-.97l-.7-.94c.24-.43.42-.87.54-1.32l1.16-.2c.36-.05.63-.37.63-.74v-1.95a.76.76 0 0 0-.63-.74Z"
              />
            </svg>
          </button>
        </div>
      </header>

      <section class="control-panel-vertical" aria-label="コントロールパネル">
        <div class="dropzone" data-target="a">
          <header class="dropzone-header">
            <div class="dropzone-title">
              <h2>BOM A</h2>
              <button
                type="button"
                class="info-button"
                aria-label="BOM Aについて"
                data-tooltip="比較の基準となる既存BOMを読み込みます"
              >
                i
              </button>
            </div>
            <span class="dropzone-status" data-status-placeholder="a">未読込</span>
          </header>
          <div class="dropzone-body">
            <div class="dropzone-surface" data-surface="a">
              <div class="dropzone-placeholder" data-placeholder="a">
                <div class="dropzone-placeholder-icon">⇣</div>
                <p>ここにファイルをドラッグ＆ドロップ</p>
                <small>CSV / XLSX / CADネットリスト 対応</small>
              </div>
              <div class="dropzone-preview" id="drop-preview-a" hidden>
                <header class="drop-preview-header">
                  <div>
                    <h3>BOM A プレビュー</h3>
                    <p class="drop-preview-meta" data-preview-meta-short="a">-</p>
                  </div>
                  <button
                    class="outline-button"
                    data-open-edit="a"
                    disabled
                    data-tooltip="BOM Aの内容を確認・編集します"
                  >
                    編集...
                  </button>
                </header>
                <div class="drop-preview-errors" data-preview-errors="a" hidden></div>
                <div class="preview-with-settings">
                  <div class="drop-preview-table" data-preview-table="a"></div>
                  <div class="column-settings-panel" data-column-settings="a">
                    <h4>列設定</h4>
                    <div class="column-setting-group">
                      <label>
                        Ref (部品番号):
                        <select class="column-select" data-column-role="ref" data-dataset="a">
                          <option value="">--</option>
                        </select>
                      </label>
                    </div>
                    <div class="column-setting-group">
                      <label>
                        Part No (部品型番):
                        <select class="column-select" data-column-role="part_no" data-dataset="a">
                          <option value="">--</option>
                        </select>
                      </label>
                    </div>
                    <div class="column-setting-group">
                      <label>
                        Manufacturer (メーカー):
                        <select class="column-select" data-column-role="manufacturer" data-dataset="a">
                          <option value="">--</option>
                        </select>
                      </label>
                    </div>
                    <button type="button" class="secondary-button column-default-preprocess" data-default-preprocess="a">
                      デフォルト前処理
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <footer class="dropzone-footer">
            <button
              class="secondary-button"
              data-select-target="a"
              data-tooltip="ファイルダイアログからBOM Aを読み込みます"
            >
              ファイルを選択
            </button>
          </footer>
        </div>

        <div class="dropzone" data-target="b">
          <header class="dropzone-header">
            <div class="dropzone-title">
              <h2>BOM B</h2>
              <button
                type="button"
                class="info-button"
                aria-label="BOM Bについて"
                data-tooltip="比較対象となる新しいBOMを読み込みます"
              >
                i
              </button>
            </div>
            <span class="dropzone-status" data-status-placeholder="b">未読込</span>
          </header>
          <div class="dropzone-body">
            <div class="dropzone-surface" data-surface="b">
              <div class="dropzone-placeholder" data-placeholder="b">
                <div class="dropzone-placeholder-icon">⇣</div>
                <p>ここにファイルをドラッグ＆ドロップ</p>
                <small>CSV / XLSX / CADネットリスト 対応</small>
              </div>
              <div class="dropzone-preview" id="drop-preview-b" hidden>
                <header class="drop-preview-header">
                  <div>
                    <h3>BOM B プレビュー</h3>
                    <p class="drop-preview-meta" data-preview-meta-short="b">-</p>
                  </div>
                  <button
                    class="outline-button"
                    data-open-edit="b"
                    disabled
                    data-tooltip="BOM Bの内容を確認・編集します"
                  >
                    編集...
                  </button>
                </header>
                <div class="drop-preview-errors" data-preview-errors="b" hidden></div>
                <div class="preview-with-settings">
                  <div class="drop-preview-table" data-preview-table="b"></div>
                  <div class="column-settings-panel" data-column-settings="b">
                    <h4>列設定</h4>
                    <div class="column-setting-group">
                      <label>
                        Ref (部品番号):
                        <select class="column-select" data-column-role="ref" data-dataset="b">
                          <option value="">--</option>
                        </select>
                      </label>
                    </div>
                    <div class="column-setting-group">
                      <label>
                        Part No (部品型番):
                        <select class="column-select" data-column-role="part_no" data-dataset="b">
                          <option value="">--</option>
                        </select>
                      </label>
                    </div>
                    <div class="column-setting-group">
                      <label>
                        Manufacturer (メーカー):
                        <select class="column-select" data-column-role="manufacturer" data-dataset="b">
                          <option value="">--</option>
                        </select>
                      </label>
                    </div>
                    <button type="button" class="secondary-button column-default-preprocess" data-default-preprocess="b">
                      デフォルト前処理
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <footer class="dropzone-footer">
            <button
              class="secondary-button"
              data-select-target="b"
              data-tooltip="ファイルダイアログからBOM Bを読み込みます"
            >
              ファイルを選択
            </button>
          </footer>
        </div>

        <div class="primary-actions">
          <button
            class="primary-button"
            id="run-compare"
            disabled
            data-tooltip="読み込んだBOM同士の差分を確認します"
          >
            <span>比較を実行</span>
          </button>
          <button
            class="danger-button"
            id="run-replace"
            disabled
            data-tooltip="BOM AをBOM Bで更新し、新しい一覧を作成します"
          >
            <span>AをBで置き換え</span>
          </button>
        </div>

        <div class="export-actions" id="export-actions">
          <button class="secondary-button" id="export-csv-main">
            BOM AのCSV出力
          </button>
          <button class="primary-button" id="export-eco-main">
            BOM AのECO出力
          </button>
          <button class="primary-button" id="export-ccf-main">
            BOM AのCCF出力
          </button>
          <button class="primary-button" id="export-msf-main">
            BOM AのMSF出力
          </button>
        </div>
      </section>

      <section class="preview-section">
        <div class="workspace-empty" id="preview-empty-message">
          ファイルを読み込むとここにプレビューが表示されます。
        </div>
        <div class="preview-grid" hidden>
          <article class="preview-card" data-source="a" hidden>
            <header>
              <div class="section-heading">
                <h3>BOM A プレビュー</h3>
                <p class="preview-meta" id="preview-meta-a">未読込</p>
                <button
                  type="button"
                  class="info-button"
                  aria-label="BOM Aプレビューについて"
                  data-tooltip="読み込んだBOM Aの先頭部分と警告を確認できます"
                >
                  i
                </button>
              </div>
              <button
                class="outline-button"
                data-open-edit="a"
                disabled
                data-tooltip="BOM Aの編集モードを開きます"
              >
                編集...
              </button>
            </header>
            <div class="preview-content">
              <div class="preview-table-wrapper" id="preview-table-a" hidden></div>
              <div class="preview-errors" id="preview-errors-a" hidden></div>
            </div>
          </article>

          <article class="preview-card" data-source="b" hidden>
            <header>
              <div class="section-heading">
                <h3>BOM B プレビュー</h3>
                <p class="preview-meta" id="preview-meta-b">未読込</p>
                <button
                  type="button"
                  class="info-button"
                  aria-label="BOM Bプレビューについて"
                  data-tooltip="読み込んだBOM Bの先頭部分と警告を確認できます"
                >
                  i
                </button>
              </div>
              <button
                class="outline-button"
                data-open-edit="b"
                disabled
                data-tooltip="BOM Bの編集モードを開きます"
              >
                編集...
              </button>
            </header>
            <div class="preview-content">
              <div class="preview-table-wrapper" id="preview-table-b" hidden></div>
              <div class="preview-errors" id="preview-errors-b" hidden></div>
            </div>
          </article>
        </div>
      </section>

      <section class="results-panel" id="results-panel" hidden>
        <div class="results-header">
          <div class="results-filter-controls" id="results-filter-controls" hidden>
            <button class="filter-button" id="filter-all" data-tooltip="全件データを表示">
              全件
            </button>
            <button class="filter-button is-active" id="filter-diff" data-tooltip="全ての差分を表示">
              差分 (<span id="count-total">0</span>)
            </button>
            <button class="filter-button filter-added" id="filter-added" data-tooltip="追加された項目のみ表示">
              追加 (<span id="count-added">0</span>)
            </button>
            <button class="filter-button filter-removed" id="filter-removed" data-tooltip="削除された項目のみ表示">
              削除 (<span id="count-removed">0</span>)
            </button>
            <button class="filter-button filter-changed" id="filter-changed" data-tooltip="変更された項目のみ表示">
              変更 (<span id="count-changed">0</span>)
            </button>
            <button class="outline-button" id="print-results" data-tooltip="結果を印刷します">
              🖨️ 印刷
            </button>
          </div>
          <div class="results-actions" id="results-actions" hidden>
            <button class="secondary-button" id="export-csv">
              結果のCSV出力
            </button>
            <button class="primary-button" id="export-eco">
              結果のECO出力
            </button>
            <button class="primary-button" id="export-ccf">
              結果のCCF出力
            </button>
            <button class="primary-button" id="export-msf">
              結果のMSF出力
            </button>
          </div>
        </div>
        <div class="results-table-wrapper" id="diff-result" hidden></div>
      </section>

      <footer class="supplementary-panel">
        <section class="project-panel">
          <header>
            <div class="section-heading">
              <h2>プロジェクト一覧</h2>
              <button
                type="button"
                class="info-button"
                aria-label="プロジェクト一覧について"
                data-tooltip="保存済みのタブを切り替えたり、別ウィンドウで開いたりできます"
              >
                i
              </button>
            </div>
          </header>
          <div class="project-tab-scroll">
            <div class="favorites-section">
              <h4 class="favorites-header">お気に入り</h4>
              <div class="favorites-tab-bar" id="favorites-tab-bar">
                <p class="session-tab-empty">お気に入りはありません</p>
              </div>
            </div>
            <div class="all-projects-section">
              <h4 class="projects-header">全てのプロジェクト</h4>
              <div class="session-tab-bar" id="session-tab-bar">
                <p class="session-tab-empty">保存されたプロジェクトはありません</p>
              </div>
            </div>
          </div>
        </section>
        <section class="log-panel">
          <header>
            <div class="section-heading">
              <h2>アクティビティログ</h2>
              <button
                type="button"
                class="info-button"
                aria-label="アクティビティログについて"
                data-tooltip="直近の操作履歴や実行結果を自動で記録します"
              >
                i
              </button>
            </div>
          </header>
          <ul class="activity-log" id="activity-log"></ul>
        </section>
      </footer>
    </main>

    <div class="processing-overlay" id="processing-overlay" hidden>
      <div class="overlay-backdrop"></div>
      <div class="overlay-content">
        <div class="overlay-spinner"></div>
        <p id="processing-message">処理中...</p>
      </div>
    </div>

    <dialog class="modal" id="edit-modal">
      <form method="dialog" class="modal-inner">
        <header class="modal-header">
          <div>
            <h2 id="edit-modal-title">編集モード</h2>
            <p id="edit-modal-subtitle" class="modal-subtitle"></p>
          </div>
          <div class="dataset-toggle" role="group" aria-label="編集対象BOM">
            <button
              type="button"
              class="tab is-active"
              data-edit-dataset="a"
              data-tooltip="編集対象をBOM Aに切り替えます"
            >
              BOM A
            </button>
            <button
              type="button"
              class="tab"
              data-edit-dataset="b"
              data-tooltip="編集対象をBOM Bに切り替えます"
            >
              BOM B
            </button>
          </div>
          <button
            type="button"
            class="icon-button"
            data-modal-close="edit-modal"
            aria-label="閉じる"
            data-tooltip="編集モードを閉じて前の画面に戻ります"
          >
            <span>&times;</span>
          </button>
        </header>
        <div class="modal-body">
          <section class="modal-main">
            <div class="editable-table-wrapper">
              <table id="edit-table">
                <thead id="edit-table-head"></thead>
                <tbody id="edit-table-body"></tbody>
              </table>
            </div>
            <div class="modal-warnings" id="edit-warnings" hidden>
              <h4>警告・エラー</h4>
              <ul id="edit-warnings-list"></ul>
            </div>
          </section>
          <aside class="modal-aside">
            <div class="modal-group">
              <h3>列の役割（部品番号 / 部品型番 / メーカー名）</h3>
              <div id="header-role-controls"></div>
            </div>
            <div class="modal-group">
              <h3>文字列置換</h3>
              <label>
                <span style="font-size: 13px; color: #324559;">検索する文字列</span>
                <input type="text" id="find-text" placeholder="置換前の文字列" style="width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; margin-top: 4px;" />
              </label>
              <label style="margin-top: 8px;">
                <span style="font-size: 13px; color: #324559;">置換後の文字列</span>
                <input type="text" id="replace-text" placeholder="置換後の文字列" style="width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; margin-top: 4px;" />
              </label>
              <button
                type="button"
                class="secondary-button"
                id="apply-replace"
                data-tooltip="指定した文字列を置換します"
                style="margin-top: 8px; width: 100%;"
              >
                置換を実行
              </button>
            </div>
            <div class="modal-group">
              <h3>前処理</h3>
              <label>
                <input type="checkbox" id="expand-reference" />
                Referenceの展開（例: C1-C4 → C1, C2, C3, C4）
              </label>
              <label>
                <input type="checkbox" id="split-reference-rows" />
                Referenceを行分割（1つのRefに複数Part_Noがある場合）
              </label>
              <label>
                <input type="checkbox" id="fill-blank-cells" />
                空欄セルの補完
              </label>
              <label>
                <input type="checkbox" id="cleanse-text-data" />
                テキストデータのクレンジング
              </label>
              <label>
                <input type="checkbox" id="apply-format-rules" />
                書式ルールの適用
              </label>
              <button
                type="button"
                class="ghost-button"
                id="toggle-format-rules"
                style="margin-top: 8px; font-size: 12px;"
              >
                ⚙️ 書式ルール設定
              </button>
              <div id="format-rules-config" class="format-rules-config" hidden>
                <h4>書式ルール</h4>
                <div id="format-rules-list"></div>
                <button
                  type="button"
                  class="ghost-button"
                  id="add-format-rule"
                  style="margin-top: 8px;"
                >
                  ＋ ルールを追加
                </button>
              </div>
              <button
                type="button"
                class="secondary-button"
                id="apply-preprocess"
                data-tooltip="選択された前処理をBOMに適用します"
                style="margin-top: 12px; width: 100%;"
              >
                前処理を適用
              </button>
            </div>
          </aside>
        </div>
        <footer class="modal-footer">
          <button
            type="button"
            class="ghost-button"
            data-modal-close="edit-modal"
            data-tooltip="編集内容を破棄して閉じます"
          >
            閉じる
          </button>
          <button
            type="button"
            class="primary-button"
            id="apply-edit"
            data-tooltip="編集した内容をBOMに反映します（モーダルは開いたまま）"
          >
            適用
          </button>
        </footer>
      </form>
    </dialog>

    <dialog class="modal" id="settings-modal">
      <form method="dialog" class="modal-inner">
        <header class="modal-header">
          <div>
            <h2>設定</h2>
            <p class="modal-subtitle">アプリケーションの設定をカスタマイズ</p>
          </div>
          <button
            type="button"
            class="icon-button"
            data-modal-close="settings-modal"
            aria-label="閉じる"
          >
            <span>&times;</span>
          </button>
        </header>
        <div class="modal-body settings-body">
          <!-- 自動保存設定パネル -->
          <section class="settings-panel" id="settings-panel-projects">
            <div class="settings-group">
              <h3>自動保存の間隔</h3>
              <p class="settings-description">指定した間隔ごとに自動保存を実行します（1〜180分）</p>
              <div class="settings-inline-inputs">
                <input
                  type="number"
                  id="session-auto-interval"
                  min="1"
                  max="180"
                  step="1"
                  value="15"
                />
                <span>分</span>
              </div>
            </div>
            <div class="settings-group">
              <h3>自動保存の保持数</h3>
              <p class="settings-description">最新の自動保存を何件残すか指定します（最大30件）</p>
              <input
                type="number"
                id="session-auto-count"
                min="1"
                max="30"
                step="1"
                value="10"
              />
            </div>
            <p class="settings-hint">
              手動保存はメイン画面の「タブを保存」ボタンから実行できます。
            </p>

            <div class="settings-group">
              <h3>デフォルト前処理</h3>
              <p class="settings-description">プレビュー画面の「デフォルト前処理」ボタンで実行される処理を選択します</p>
              <div class="settings-checkboxes">
                <label>
                  <input type="checkbox" id="default-preprocess-expand" checked />
                  Referenceの展開
                </label>
                <label>
                  <input type="checkbox" id="default-preprocess-split" />
                  Referenceを行分割（1つのRefに複数Part_Noがある場合）
                </label>
                <label>
                  <input type="checkbox" id="default-preprocess-fill" checked />
                  空欄セルの補完
                </label>
                <label>
                  <input type="checkbox" id="default-preprocess-cleanse" checked />
                  テキストデータのクレンジング
                </label>
                <label>
                  <input type="checkbox" id="default-preprocess-format" />
                  書式ルールの適用
                </label>
              </div>
            </div>
          </section>

          <!-- 辞書管理パネル -->
          <section class="settings-panel" id="settings-panel-dictionary">
            <nav class="sub-tabs">
              <button class="sub-tab is-active" type="button" data-dictionary-tab="registration">登録名リスト</button>
              <button class="sub-tab" type="button" data-dictionary-tab="exception">特定部品</button>
            </nav>

            <!-- 登録名リストタブ -->
            <div class="dictionary-content" id="dictionary-content-registration">
              <div class="dictionary-description">
                <p>部品型番と登録名（社内表記名）を紐付けて管理します。BOMに適用すると、同じ型番に自動で同じ登録名が割り当てられます。</p>
              </div>

              <div class="dictionary-table-actions">
                <button type="button" class="secondary-button" id="extract-from-bom">
                  📋 BOMから抽出
                </button>
                <button type="button" class="secondary-button" id="add-registration-row">
                  ➕ 行を追加
                </button>
                <button type="button" class="ghost-button" id="import-registration-csv">
                  📁 CSVインポート
                </button>
                <button type="button" class="ghost-button" id="export-registration-csv">
                  💾 CSVエクスポート
                </button>
                <button type="button" class="primary-button" id="apply-registration-to-bom">
                  ✓ BOMに適用
                </button>
              </div>

              <div class="dictionary-table-wrapper">
                <table class="dictionary-table" id="registration-table">
                  <thead>
                    <tr>
                      <th style="width: 40%">部品型番</th>
                      <th style="width: 40%">登録名</th>
                      <th style="width: 20%">操作</th>
                    </tr>
                  </thead>
                  <tbody id="registration-table-body">
                    <tr class="dictionary-empty-row">
                      <td colspan="3">データがありません。「BOMから抽出」または「行を追加」でデータを登録してください。</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 特定部品タブ -->
            <div class="dictionary-content" id="dictionary-content-exception" hidden>
              <div class="dictionary-description">
                <p>特定の部品番号（Ref）に対して、登録名リストとは別の登録名を割り当てます。登録名リストより優先して適用されます。</p>
              </div>

              <div class="dictionary-table-actions">
                <button type="button" class="secondary-button" id="add-exception-row">
                  ➕ 行を追加
                </button>
                <button type="button" class="ghost-button" id="import-exception-csv">
                  📁 CSVインポート
                </button>
                <button type="button" class="ghost-button" id="export-exception-csv">
                  💾 CSVエクスポート
                </button>
                <button type="button" class="primary-button" id="apply-exception-to-bom">
                  ✓ BOMに適用
                </button>
              </div>

              <div class="dictionary-table-wrapper">
                <table class="dictionary-table" id="exception-table">
                  <thead>
                    <tr>
                      <th style="width: 25%">部品番号 (Ref)</th>
                      <th style="width: 35%">部品型番</th>
                      <th style="width: 25%">登録名</th>
                      <th style="width: 15%">操作</th>
                    </tr>
                  </thead>
                  <tbody id="exception-table-body">
                    <tr class="dictionary-empty-row">
                      <td colspan="4">データがありません。「行を追加」でデータを登録してください。</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
        <footer class="modal-footer">
          <button type="button" class="ghost-button" data-modal-close="settings-modal">キャンセル</button>
          <button type="submit" class="primary-button" id="save-settings">設定を保存</button>
        </footer>
      </form>
    </dialog>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
